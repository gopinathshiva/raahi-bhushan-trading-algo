{% extends 'base.html' %}

{% block title %}Import Database ‚Äî Sensibull Tracker{% endblock %}

{% block breadcrumb %}
<li><span class="current">Import</span></li>
{% endblock %}

{% block head %}
<style>
    .import-wrapper {
        max-width: 700px;
        margin: 50px auto;
        padding: 0 20px;
    }

    .import-card {
        background: white;
        padding: 40px 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .import-header { text-align: center; margin-bottom: 24px; }
    .import-icon { font-size: 4rem; margin-bottom: 16px; }
    .import-header h2 { margin: 0 0 10px; color: #333; }
    .import-header p  { color: #666; margin: 0; }

    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
        font-size: 0.9em;
    }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-danger  { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 40px;
        margin: 20px 0;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    .upload-area:hover { border-color: #198754; background: #e7f5ec; }
    .upload-area.dragover { border-color: #198754; background: #d1f0dc; }

    .upload-icon { font-size: 3rem; color: #6c757d; margin-bottom: 12px; }
    .upload-area p { margin: 0; color: #555; }
    .upload-area small { color: #999; }

    .file-info { display: none; margin-top: 15px; }
    .file-info .alert { margin: 0; }

    .btn-upload {
        display: block;
        width: 100%;
        margin-top: 20px;
        padding: 14px;
        background: #198754;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-upload:hover { background: #157347; }
    .btn-upload:disabled { background: #6c757d; cursor: not-allowed; }

    hr { margin: 28px 0; border: none; border-top: 1px solid #eee; }

    .instructions h5 { margin-bottom: 10px; color: #333; }
    .instructions ol { padding-left: 20px; color: #555; line-height: 1.8; }
</style>
{% endblock %}

{% block content %}
<div class="import-wrapper">
    <div class="import-card">
        <div class="import-header">
            <div class="import-icon">‚¨ÜÔ∏è</div>
            <h2>Import Database</h2>
            <p>Upload a <strong>sensibull.db</strong> file to replace the current database.</p>
        </div>

        {% if success %}
        <div class="alert alert-success">
            ‚úÖ <strong>Success!</strong> Database imported successfully.
            You can now <a href="{{ url_for('login') }}">login</a>.
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger">
            ‚ùå <strong>Error!</strong> {{ error }}
        </div>
        {% endif %}

        <div class="alert alert-warning">
            ‚ö†Ô∏è <strong>Warning:</strong> This will completely replace your current database. All existing data will be lost!
        </div>

        <form id="uploadForm" method="POST" action="{{ url_for('import_upload') }}" enctype="multipart/form-data">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <p><strong>Click to select file or drag and drop</strong></p>
                <small>sensibull.db file only</small>
                <input type="file" id="fileInput" name="database_file" accept=".db" style="display:none;" required>
            </div>

            <div class="file-info" id="fileInfo">
                <div class="alert alert-success">
                    üìÑ <strong>Selected file:</strong> <span id="fileName"></span> &nbsp;|&nbsp;
                    <strong>Size:</strong> <span id="fileSize"></span>
                </div>
            </div>

            <button type="submit" class="btn-upload" id="uploadBtn" disabled>
                ‚¨Ü Import Database
            </button>
        </form>

        <hr>

        <div class="instructions">
            <h5>Instructions</h5>
            <ol>
                <li>Select the <code>sensibull.db</code> file you want to import</li>
                <li>Click "Import Database" to upload and replace the current database</li>
                <li>After successful import, log in with the credentials from the imported database</li>
            </ol>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput  = document.getElementById('fileInput');
    const fileInfo   = document.getElementById('fileInfo');
    const fileName   = document.getElementById('fileName');
    const fileSize   = document.getElementById('fileSize');
    const uploadBtn  = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');

    uploadArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => handleFiles(e.target.files));

    uploadArea.addEventListener('dragover',  e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
    uploadArea.addEventListener('dragleave', ()  => uploadArea.classList.remove('dragover'));
    uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        if (!files.length) return;
        const file = files[0];
        if (!file.name.endsWith('.db')) { alert('Please select a .db file'); return; }
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        uploadBtn.disabled = false;
        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    uploadForm.addEventListener('submit', () => {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '‚è≥ Importing...';
    });
</script>
{% endblock %}
